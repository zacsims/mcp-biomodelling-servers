---
name: physicell-simulation
description: >
  Build, configure, and run PhysiCell multicellular simulations using the PhysiCell MCP server.
  Use when the user asks to model tumors, cells, tissues, or multicellular biological systems.
  Covers simulation setup, cell rules (Hill functions), initial conditions, PhysiBoSS boolean
  networks, UQ/calibration, and literature validation. Prevents common configuration mistakes
  like the "from 0 towards 0" rule bug.
compatibility: Requires PhysiCell MCP server connection
metadata:
  author: simsz
  version: "1.0"
---

# PhysiCell Simulation Skill

## ABSOLUTE RULE 1: Never Edit Generated Files

You MUST call PhysiCell MCP tools using the MCP tool calling mechanism — the same way you call Read, Write, Bash, or Grep. Tools have the prefix `mcp__PhysiCell__`. Do NOT run them via Bash, subprocess, or npx.

**NEVER use the Edit, Write, or Bash tools to modify PhysiCell XML configuration files, cell_rules.csv, or cells.csv.** These files are generated by the MCP server. If you edit them directly, your changes will be overwritten on the next export, and the session state will be out of sync with the files on disk.

If you detect a problem (like "from 0 towards 0"), fix it by calling the appropriate MCP tool (e.g., `configure_cell_parameters` to set a nonzero rate), then re-export. Do NOT patch the XML. If no MCP tool exists for what you need, tell the user about the limitation rather than silently editing files.

## ABSOLUTE RULE 2: Literature Research Uses the LiteratureValidation MCP

When the user asks to base parameters on literature, determine values from published data, or validate rules against papers, you MUST use the LiteratureValidation MCP server (`mcp__LiteratureValidation__*` tools). Do NOT manually read papers/abstracts in context and extract values yourself.

**NEVER use these tools for literature research or parameter extraction:**
- `WebSearch` / `WebFetch` — NEVER use web search to find biological parameters or read papers. Web search results are unreliable, unverifiable, and waste context. Use the PubMed and bioRxiv MCP servers instead. **If the PubMed MCP is unavailable (failed to load), use WebSearch ONLY to collect PMIDs, then immediately pass them to `add_papers_by_id()`. Do NOT extract parameters from web search results.**
- `get_full_text_article` — dumps 50KB+ into context, wastes the context window
- `get_article_metadata` — reading abstracts in context to manually extract values is unreliable and wasteful

**Instead, follow this workflow:**
1. Search PubMed with `mcp__plugin_pubmed_PubMed__search_articles()` — collect PMIDs only
   - **Fallback if PubMed MCP is unavailable:** Use `WebSearch` with queries like `"hypoxia migration PMID"` to find PMIDs, then pass them to `add_papers_by_id()`. Do NOT read or extract parameters from the web search results.
2. Search bioRxiv with `mcp__plugin_biorxiv_bioRxiv__search_preprints()` — collect bioRxiv DOIs
3. Create a collection: `mcp__LiteratureValidation__create_paper_collection("model_name")`
4. Index papers with PDF download: `mcp__LiteratureValidation__add_papers_by_id(name="model_name", pmids=[...], biorxiv_dois=[...], fetch_pdfs=True)`
5. Query PaperQA for each rule: `mcp__LiteratureValidation__validate_rule(name="model_name", cell_type=..., signal=..., direction=..., behavior=..., half_max=..., hill_power=...)`
6. Review: `mcp__LiteratureValidation__get_validation_summary("model_name")`

PaperQA indexes full PDFs (from PubMed Central, 68+ publishers, and preprint servers) and uses RAG to extract quantitative parameters — far more accurate than web search or reading abstracts. Use `search_articles` ONLY to find PMIDs, then hand them to `add_papers_by_id`. See Section 7 for the full workflow.

## 1. Mandatory Tool Ordering

Follow this sequence. Do not skip steps.

```
create_session
  → analyze_biological_scenario
  → [LITERATURE RESEARCH — if user asks to base parameters on literature, SEE SECTION 7]
  → create_simulation_domain
  → add_single_substrate          (repeat for each substrate)
  → add_single_cell_type          (repeat for each cell type)
  → configure_cell_parameters     (repeat for each cell type)
  → set_substrate_interaction     (repeat for each cell×substrate pair)
  → add_single_cell_rule          (repeat for each rule — SEE SECTION 2)
  → place_initial_cells           (repeat for each cell placement)
  → export_xml_configuration
  → export_cell_rules_csv
  → export_cells_csv              (if cells were placed)
  → create_physicell_project
  → compile_physicell_project
  → run_simulation
  → get_simulation_status         (poll until complete)
  → generate_simulation_gif
```

## 2. Hill Function Rules — CRITICAL

### How rules work in PhysiCell

The `add_single_cell_rule` tool writes a CSV row:

```
cell_type, signal, direction, behavior, base_value, half_max, hill_power, apply_to_dead
```

PhysiCell reads this CSV and computes behavior values using the Hill function:

```
                                      signal^n
behavior = base_value + (saturation - base_value) × ─────────────────
                                      half_max^n + signal^n
```

Where:
- **base_value** = `min_signal` parameter from the tool (default: 0). This is the behavior value when the signal is absent/low.
- **saturation** = the XML default rate for that behavior. This is NOT a tool parameter — it comes from the cell type definition in the XML.
- **half_max** = signal level at which the behavior is halfway between base and saturation.
- **n** = `hill_power` (steepness: 1=gradual, 4=moderate, 8=switch-like).

For `direction = "increases"`: behavior goes from base_value (low signal) toward saturation (high signal).
For `direction = "decreases"`: behavior goes from saturation (low signal) toward base_value (high signal).

### The "From 0 Towards 0" Bug

**This is the #1 most common PhysiCell configuration mistake.**

If `base_value = 0` AND the XML default rate for the behavior is also 0, the Hill function computes:

```
behavior = 0 + (0 - 0) × Hill(signal) = 0    ← ALWAYS ZERO, rule does nothing!
```

**The rule silently has no effect.** No error is raised. The simulation runs but the intended behavior never activates.

### Prevention Checklist — BEFORE adding any rule

For each rule you plan to add, check:

1. **What is the target behavior?** (e.g., "cycle entry", "apoptosis", "necrosis", "migration speed")
2. **What is its XML default value?** This depends on what was set via `configure_cell_parameters` or the cell type template.
3. **Is the default nonzero?**

| Behavior | Default | Setter tool |
|---|---|---|
| cycle entry | Depends on cycle model (Ki67_basic ≈ 0.00072) | Usually safe as-is |
| apoptosis / necrosis | Set via `configure_cell_parameters` | `apoptosis_rate`, `necrosis_rate` |
| migration speed / persistence | Set via `configure_cell_parameters` | `motility_speed`, `persistence_time` |
| X secretion / X uptake | 0 | `set_substrate_interaction()` |
| transition to X | 0 | `set_cell_transformation_rate()` |
| attack X / phagocytose X / fuse to X | 0 | `set_cell_interaction()` |
| phagocytose apoptotic/necrotic/other dead cell | 0 | `configure_cell_interactions()` |
| cell attachment rate / cell detachment rate | 0 | `configure_cell_mechanics()` |
| damage rate / damage repair rate | 0 | `configure_cell_integrity()` |
| exit from cycle phase N | Often 0 | No setter — use nonzero `min_signal` |
| custom behaviors | 0 | No setter — use nonzero `min_signal` |

**If the XML default is 0, you MUST set a nonzero rate BEFORE adding the rule.** The server validates rules and rejects "from 0 towards 0" with a specific error message guiding you to the correct setter tool.

**Examples — setting nonzero defaults before rules:**

```
# Death rates, motility, volume:
configure_cell_parameters(cell_type="tumor", apoptosis_rate=0.001, necrosis_rate=0.00277, motility_speed=0.5)

# Secretion/uptake:
set_substrate_interaction(cell_type="tumor", substrate="chemokine", secretion_rate=0.1)

# Cell transformation:
set_cell_transformation_rate(cell_type="tumor", target_cell_type="motile_tumor", rate=0.001)

# Per-cell-type interactions (attack, phagocytose live, fuse):
set_cell_interaction(cell_type="macrophage", target_cell_type="tumor", interaction_type="attack", rate=0.1)
set_cell_interaction(cell_type="macrophage", target_cell_type="tumor", interaction_type="phagocytose", rate=0.01)

# Dead-cell phagocytosis:
configure_cell_interactions(cell_type="macrophage", apoptotic_phagocytosis_rate=0.01, necrotic_phagocytosis_rate=0.01)

# Attachment/detachment:
configure_cell_mechanics(cell_type="tumor", attachment_rate=0.01, detachment_rate=0.001)

# Damage/repair:
configure_cell_integrity(cell_type="tumor", damage_rate=0.001, damage_repair_rate=0.0001)
```

### Worked Example: Oxygen → Necrosis

Goal: Low oxygen increases necrosis rate.

```python
# 1. Cell type already has necrosis_rate=0.0001 from configure_cell_parameters → XML default = 0.0001 ✓
# 2. Rule: oxygen DECREASES necrosis (high O2 = less necrosis)
add_single_cell_rule(
    cell_type="tumor",
    signal="oxygen",
    direction="decreases",     # high oxygen → LESS necrosis
    behavior="necrosis",
    min_signal=0.0,            # base_value: necrosis rate when signal is saturated (high O2)
    max_signal=38,             # informational, not written to CSV
    half_max=5.0,              # oxygen level at 50% effect
    hill_power=4               # moderately steep response
)
# Result: necrosis = 0 at high O2, rises toward 0.0001 (XML default) as O2 drops ✓
```

## 3. Common Mistakes Quick Reference

| # | Mistake | Symptom | Fix |
|---|---------|---------|-----|
| 1 | "From 0 towards 0" rule | Rule has no effect, cells ignore signal | Set nonzero XML default for the target behavior BEFORE adding rule |
| 2 | Dirichlet not enabled per-boundary | Substrate not maintained at boundaries | Set `dirichlet_enabled=True` in `add_single_substrate` |
| 3 | Wrong cycle model | Desired transition doesn't exist | Check `get_available_cycle_models()` |
| 4 | Cells placed outside domain | Cells immediately removed or ignored | Ensure placement radius/bounds fit within `create_simulation_domain` extents |
| 5 | Rule references nonexistent substrate | Rule silently fails | Add substrate BEFORE rules |
| 6 | Missing `export_cells_csv` | cells.csv not in project, no initial cells | Call `export_cells_csv()` before `create_physicell_project()` |
| 7 | No substrate interactions set | Cells don't consume/produce substrates | Call `set_substrate_interaction()` for each cell×substrate |
| 8 | `increases` vs `decreases` swapped | Behavior responds opposite to intent | "increases" = more signal → more behavior |
| 9 | Not checking simulation status | Don't know if simulation succeeded | Always call `get_simulation_status()` after `run_simulation()` |
| 10 | Forgetting `compile_physicell_project` | Simulation fails to run | Must compile before running |

## 4. Substrate Defaults

Use these typical values when adding substrates:

| Substrate | Diffusion (μm²/min) | Decay (1/min) | Initial | Dirichlet | Units |
|-----------|---------------------|---------------|---------|-----------|-------|
| oxygen | 100000 | 0.1 | 38.0 | 38.0 (enabled) | mmHg |
| glucose | 30000 | 0.0025 | 16.9 | 16.9 | mM |
| chemokine | 50000 | 0.01 | 0.0 | — | dimensionless |
| drug | 100000 | 0.01-0.1 | 0.0 | varies | μM |
| VEGF | 20000 | 0.01 | 0.0 | — | dimensionless |

For oxygen, **always enable Dirichlet boundaries** to maintain oxygenation:
```python
add_single_substrate(
    substrate_name="oxygen",
    diffusion_coefficient=100000,
    decay_rate=0.1,
    initial_condition=38.0,
    dirichlet_enabled=True,
    dirichlet_value=38.0,
    units="mmHg"
)
```

## 5. Cell Placement Patterns

| Pattern | Use when... | Key parameters |
|---------|------------|----------------|
| `random_disc` | Tumor mass, circular colony | center_x, center_y, radius, num_cells |
| `random_rectangle` | Tissue layer, rectangular region | x_min, x_max, y_min, y_max, num_cells |
| `single` | Individual cell placement | center_x, center_y |
| `grid` | Uniform tissue, monolayer | x_min, x_max, y_min, y_max, spacing |
| `annular` | Ring of cells (e.g., immune ring around tumor) | center_x, center_y, radius, inner_radius, num_cells |

Ensure all placements fit within the simulation domain. A 1000×1000 domain spans -500 to +500 in each axis.

## 6. Substrate Interactions

For every cell type × substrate pair, decide if cells consume, secrete, or ignore the substrate:

```python
# Tumor cells consume oxygen
set_substrate_interaction(cell_type="tumor", substrate="oxygen", uptake_rate=10.0)

# Tumor cells secrete chemokine
set_substrate_interaction(cell_type="tumor", substrate="chemokine", secretion_rate=0.1)
```

Common uptake rates:
- Oxygen uptake: 10.0 (typical tumor), 5.0 (normal cells)
- Glucose uptake: 0.5-2.0
- Drug uptake: 0.01-0.1

## 7. Literature-Based Parameters and Validation

### IMPORTANT: Never read full papers into context

**NEVER use `get_full_text_article` from the PubMed MCP server.** It dumps entire papers (50KB+) into the conversation context, which wastes context and is ineffective for extracting parameters.

Instead, **always use the LiteratureValidation MCP server** to download and index papers as PDFs into PaperQA, then query them with `validate_rule()`. This applies to:
- **Finding parameters from literature** (user says "base on literature", "determine from literature", "use published values")
- **Validating rules after defining them** (user says "validate against literature", "check my rules")

### When to use this workflow

Use this workflow whenever the user asks you to determine rules, parameters, or biological relationships from published research. Do NOT try to extract parameters by reading papers directly — use PaperQA's RAG pipeline via the LiteratureValidation MCP.

### Step-by-step workflow

**Phase 1: Build a paper collection**
1. `mcp__LiteratureValidation__create_paper_collection("model_name")` — create PaperQA document store
2. `mcp__LiteratureValidation__suggest_search_queries(cell_type, signal, direction, behavior)` — get optimized PubMed queries and bioRxiv category suggestions
3. Search PubMed: `mcp__plugin_pubmed_PubMed__search_articles(query)` — find relevant papers
   - **If PubMed MCP is unavailable:** Use `WebSearch` to find PMIDs (e.g. search `"hypoxia tumor migration PMID"`). Extract ONLY the PMIDs from results — do NOT read or use any other content from web search. Then proceed to step 4.
4. Add papers by PMID with PDF download: `mcp__LiteratureValidation__add_papers_by_id(name, pmids=[...], fetch_pdfs=True)` — this automatically fetches metadata, downloads PDFs from PubMed Central when available, and indexes them in PaperQA
5. Optionally search bioRxiv: `mcp__plugin_biorxiv_bioRxiv__search_preprints(category=..., recent_days=90)` — find recent preprints
6. Add bioRxiv preprints: `mcp__LiteratureValidation__add_papers_by_id(name, biorxiv_dois=[...])` — PDFs are always available from bioRxiv
7. Repeat steps 2-6 for each biological relationship you need to investigate

**Phase 2: Query the literature**
8. `mcp__LiteratureValidation__validate_rule(name, cell_type, signal, direction, behavior, half_max, hill_power)` — ask PaperQA about a specific rule, including proposed parameter values
9. Or `mcp__LiteratureValidation__validate_rules_batch(name, rules)` — validate all rules at once
10. `mcp__LiteratureValidation__get_validation_summary(name)` — overview of support levels

**Phase 3: Persist results (optional)**
11. `mcp__PhysiCell__store_validation_results(validations)` — save in PhysiCell session
12. `mcp__PhysiCell__get_validation_report()` — full report

### Key tools for adding papers

- **`add_papers_by_id(name, pmids=[...], biorxiv_dois=[...], fetch_pdfs=True)`** — Preferred method. Give it PMIDs or bioRxiv DOIs and it handles everything: metadata fetch, PDF download, PaperQA indexing. Falls back to abstract text when PDFs aren't available (~84% of PubMed articles lack PMC full text).
- **`add_papers_to_collection(name, papers, fetch_pdfs=True)`** — Alternative when you already have paper metadata. Pass `fetch_pdfs=True` to attempt PDF downloads.

### What NOT to do

- Do NOT use `WebSearch` or `WebFetch` for biological parameters — web search is unreliable and unverifiable. Use PubMed/bioRxiv MCP servers to find papers, then LiteratureValidation MCP to extract parameters.
- Do NOT use `get_full_text_article` — wastes context with 50KB+ responses
- Do NOT use `get_article_metadata` to read abstracts into context and then manually extract parameter values — let PaperQA do the extraction via `validate_rule()`
- Do NOT skip the LiteratureValidation MCP when the user asks for literature-based parameters
- Do NOT invent parameter values from general knowledge — all values must come from indexed literature via PaperQA

**Support levels:** strong, moderate, weak, contradictory, unsupported.
Rules flagged `unsupported` or `contradictory` should be reviewed. Validation may suggest parameter changes (half_max, hill_power).

## 8. Post-Simulation Checklist

After `run_simulation()`:
1. Poll `get_simulation_status()` until complete
2. Call `generate_simulation_gif()` to visualize
3. Call `get_simulation_output_files()` to list outputs
4. Verify cell counts are changing over time (not static)
5. If rules seem inactive, check `detailed_rules.txt` in output for "from X towards Y" values

## 9. Reference Files

For deep dives on specific topics:

- **`references/rules-and-hill-functions.md`** — Full Hill function math, worked examples, "from 0 towards 0" deep dive
- **`references/parameter-reference.md`** — Typical biological parameter values by cell type
- **`references/troubleshooting.md`** — Error diagnosis by symptom
- **`references/uq-calibration-workflow.md`** — Sensitivity analysis and calibration workflows
- **`references/physiboss-integration.md`** — Boolean network (MaBoSS/PhysiBoSS) integration
- **`references/literature-validation.md`** — Multi-server literature research and validation workflow (PDF indexing, PaperQA, bioRxiv)

## 10. Quick Start Template

For a basic tumor growth simulation:

```
1. create_session()
2. analyze_biological_scenario("Tumor growth with oxygen-dependent proliferation and necrosis")
3. create_simulation_domain(domain_x=1000, domain_y=1000, domain_z=20, max_time=4320)
4. add_single_substrate("oxygen", 100000, 0.1, 38.0, dirichlet_enabled=True, dirichlet_value=38.0, units="mmHg")
5. add_single_cell_type("tumor")
6. configure_cell_parameters(cell_type="tumor", volume_total=2500, motility_speed=0.5, apoptosis_rate=5.31667e-5, necrosis_rate=0.00277)
7. set_substrate_interaction(cell_type="tumor", substrate="oxygen", uptake_rate=10.0)
8. add_single_cell_rule(cell_type="tumor", signal="oxygen", direction="decreases", behavior="necrosis", min_signal=0, half_max=3.75, hill_power=8)
9. add_single_cell_rule(cell_type="tumor", signal="pressure", direction="decreases", behavior="cycle entry", min_signal=0, half_max=1.0, hill_power=4)
10. place_initial_cells(cell_type="tumor", pattern="random_disc", num_cells=200, radius=100)
11. export_xml_configuration()
12. export_cell_rules_csv()
13. export_cells_csv()
14. create_physicell_project("tumor_growth")
15. compile_physicell_project("tumor_growth")
16. run_simulation("tumor_growth")
17. get_simulation_status(simulation_id)   # poll until complete
18. generate_simulation_gif(simulation_id)
```
