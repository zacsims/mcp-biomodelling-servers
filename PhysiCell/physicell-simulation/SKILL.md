---
name: physicell-simulation
description: >
  Build, configure, and run PhysiCell multicellular simulations using the PhysiCell MCP server.
  Use when the user asks to model tumors, cells, tissues, or multicellular biological systems.
  Covers simulation setup, cell rules (Hill functions), initial conditions, PhysiBoSS boolean
  networks, UQ/calibration, and literature validation. Prevents common configuration mistakes
  like the "from 0 towards 0" rule bug.
compatibility: Requires PhysiCell MCP server connection
metadata:
  author: simsz
  version: "1.0"
---

# PhysiCell Simulation Skill

## ABSOLUTE RULE 1: Never Edit Generated Files

You MUST call PhysiCell MCP tools using the MCP tool calling mechanism — the same way you call Read, Write, Bash, or Grep. Tools have the prefix `mcp__PhysiCell__`. Do NOT run them via Bash, subprocess, or npx.

**NEVER use the Edit, Write, or Bash tools to modify PhysiCell XML configuration files, cell_rules.csv, or cells.csv.** These files are generated by the MCP server. If you edit them directly, your changes will be overwritten on the next export, and the session state will be out of sync with the files on disk.

If you detect a problem (like "from 0 towards 0"), fix it by calling the appropriate MCP tool (e.g., `configure_cell_parameters` to set a nonzero rate), then re-export. Do NOT patch the XML. If no MCP tool exists for what you need, tell the user about the limitation rather than silently editing files.

## ABSOLUTE RULE 2: Literature Research Uses the LiteratureValidation MCP

When the user asks to base parameters on literature, determine values from published data, or validate rules against papers, you MUST use the LiteratureValidation MCP server (`mcp__LiteratureValidation__*` tools) **directly from the main conversation**. Do NOT manually read papers/abstracts in context and extract values yourself.

**NEVER extract biological parameters from these sources:**
- `get_full_text_article` — dumps 50KB+ into context, wastes the context window
- `get_article_metadata` — reading abstracts in context to manually extract values is unreliable and wasteful
- `WebSearch` / `WebFetch` results — NEVER extract parameter values (half_max, hill_power, rates) from web search snippets. Web results lack the rigor of PaperQA's RAG pipeline.

**WebSearch IS allowed for finding paper identifiers:**
- Use `WebSearch` to find **PMIDs and bioRxiv DOIs** when PubMed MCP is unavailable or rate-limited
- Example queries: `"hypoxia tumor migration PMID"`, `"oxygen necrosis threshold tumor site:biorxiv.org"`
- Pass discovered PMIDs/DOIs to `add_papers_by_id()` — do NOT read the web results for parameter values

**NEVER use `add_papers_to_collection()`** — this tool allows passing arbitrary text as "papers," which creates circular validation when the text comes from your own training data. Use **only** `add_papers_by_id()` with real PMIDs or bioRxiv DOIs.

**Instead, follow this workflow:**
1. Search **bioRxiv first** with `mcp__plugin_biorxiv_bioRxiv__search_preprints()` — no rate limiting, 100% PDF availability
2. Search PubMed with `mcp__plugin_pubmed_PubMed__search_articles()` — collect PMIDs only
   - **If PubMed is unavailable or rate-limited:** Use `WebSearch` with queries like `"hypoxia migration PMID"` to find PMIDs.
3. Create a collection: `mcp__LiteratureValidation__create_paper_collection("model_name")`
4. Index papers with PDF download: `mcp__LiteratureValidation__add_papers_by_id(name="model_name", pmids=[...], biorxiv_dois=[...], fetch_pdfs=True)`
5. Query PaperQA for each rule: `mcp__LiteratureValidation__validate_rule(name="model_name", cell_type=..., signal=..., direction=..., behavior=..., half_max=..., hill_power=...)`
6. Review: `mcp__LiteratureValidation__get_validation_summary("model_name")`

PaperQA indexes full PDFs (from PubMed Central, 68+ publishers, and preprint servers) and uses RAG to extract quantitative parameters — far more accurate than web search or reading abstracts. See Section 7 for the full workflow.

## ABSOLUTE RULE 3: No Background Agents for Literature Research

**NEVER delegate literature research to a background agent or subagent (Task tool).** Subagents do NOT have access to MCP tools (LiteratureValidation, PubMed, bioRxiv). If you launch a subagent for literature, it will fall back to WebSearch and extract unreliable parameters.

**NEVER proceed with export/compile/run while literature validation is pending.** If the user asked for literature validation, it must complete BEFORE exporting configuration files.

The correct approach is:
1. Build the full model (substrates, cell types, rules, initial cells) in the main conversation
2. Validate ALL rules against literature using MCP tools (Section 7)
3. Adjust parameters if validation flags issues
4. THEN export, compile, and run

## 1. Mandatory Tool Ordering

Follow this sequence. Do not skip steps.

```
create_session
  → analyze_biological_scenario
  → create_simulation_domain
  → add_single_substrate          (repeat for each substrate)
  → add_single_cell_type          (repeat for each cell type)
  → configure_cell_parameters     (repeat for each cell type)
  → set_substrate_interaction     (repeat for each cell×substrate pair)
  → add_single_cell_rule          (repeat for each rule — SEE SECTION 2)
  → place_initial_cells           (repeat for each cell placement)
  → [LITERATURE VALIDATION — if user asks to validate against literature, SEE SECTION 7]
  → export_xml_configuration
  → export_cell_rules_csv
  → export_cells_csv              (if cells were placed)
  → create_physicell_project
  → compile_physicell_project
  → run_simulation
  → get_simulation_status         (poll every 60s until complete)
  → generate_simulation_gif
```

**Literature validation comes AFTER rules are defined.** Build the model first using your biological knowledge and the scenario analysis, then validate the rules and parameters against indexed literature. This lets PaperQA check your proposed parameter values (half_max, hill_power) against published data. If validation flags issues, adjust parameters before exporting.

## 2. Hill Function Rules — CRITICAL

### How rules work in PhysiCell

The `add_single_cell_rule` tool writes a CSV row:

```
cell_type, signal, direction, behavior, base_value, half_max, hill_power, apply_to_dead
```

PhysiCell reads this CSV and computes behavior values using the Hill function:

```
                                      signal^n
behavior = base_value + (saturation - base_value) × ─────────────────
                                      half_max^n + signal^n
```

Where:
- **base_value** = `min_signal` parameter from the tool (default: 0). This is the behavior value when the signal is absent/low.
- **saturation** = the XML default rate for that behavior. This is NOT a tool parameter — it comes from the cell type definition in the XML.
- **half_max** = signal level at which the behavior is halfway between base and saturation.
- **n** = `hill_power` (steepness: 1=gradual, 4=moderate, 8=switch-like).

For `direction = "increases"`: behavior goes from base_value (low signal) toward saturation (high signal).
For `direction = "decreases"`: behavior goes from saturation (low signal) toward base_value (high signal).

### The "From 0 Towards 0" Bug

**This is the #1 most common PhysiCell configuration mistake.**

If `base_value = 0` AND the XML default rate for the behavior is also 0, the Hill function computes:

```
behavior = 0 + (0 - 0) × Hill(signal) = 0    ← ALWAYS ZERO, rule does nothing!
```

**The rule silently has no effect.** No error is raised. The simulation runs but the intended behavior never activates.

### Prevention Checklist — BEFORE adding any rule

For each rule you plan to add, check:

1. **What is the target behavior?** (e.g., "cycle entry", "apoptosis", "necrosis", "migration speed")
2. **What is its XML default value?** This depends on what was set via `configure_cell_parameters` or the cell type template.
3. **Is the default nonzero?**

| Behavior | Default | Setter tool |
|---|---|---|
| cycle entry | Depends on cycle model (Ki67_basic ≈ 0.00072) | Usually safe as-is |
| apoptosis / necrosis | Set via `configure_cell_parameters` | `apoptosis_rate`, `necrosis_rate` |
| migration speed / persistence | Set via `configure_cell_parameters` | `motility_speed`, `persistence_time` |
| X secretion / X uptake | 0 | `set_substrate_interaction()` |
| transition to X | 0 | `set_cell_transformation_rate()` |
| attack X / phagocytose X / fuse to X | 0 | `set_cell_interaction()` |
| phagocytose apoptotic/necrotic/other dead cell | 0 | `configure_cell_interactions()` |
| cell attachment rate / cell detachment rate | 0 | `configure_cell_mechanics()` |
| damage rate / damage repair rate | 0 | `configure_cell_integrity()` |
| exit from cycle phase N | Often 0 | No setter — use nonzero `min_signal` |
| custom behaviors | 0 | No setter — use nonzero `min_signal` |

**If the XML default is 0, you MUST set a nonzero rate BEFORE adding the rule.** The server validates rules and rejects "from 0 towards 0" with a specific error message guiding you to the correct setter tool.

**Examples — setting nonzero defaults before rules:**

```
# Death rates, motility, volume:
configure_cell_parameters(cell_type="tumor", apoptosis_rate=0.001, necrosis_rate=0.00277, motility_speed=0.5)

# Secretion/uptake:
set_substrate_interaction(cell_type="tumor", substrate="chemokine", secretion_rate=0.1)

# Cell transformation:
set_cell_transformation_rate(cell_type="tumor", target_cell_type="motile_tumor", rate=0.001)

# Per-cell-type interactions (attack, phagocytose live, fuse):
set_cell_interaction(cell_type="macrophage", target_cell_type="tumor", interaction_type="attack", rate=0.1)
set_cell_interaction(cell_type="macrophage", target_cell_type="tumor", interaction_type="phagocytose", rate=0.01)

# Dead-cell phagocytosis:
configure_cell_interactions(cell_type="macrophage", apoptotic_phagocytosis_rate=0.01, necrotic_phagocytosis_rate=0.01)

# Attachment/detachment:
configure_cell_mechanics(cell_type="tumor", attachment_rate=0.01, detachment_rate=0.001)

# Damage/repair:
configure_cell_integrity(cell_type="tumor", damage_rate=0.001, damage_repair_rate=0.0001)
```

### Worked Example: Oxygen → Necrosis

Goal: Low oxygen increases necrosis rate.

```python
# 1. Cell type already has necrosis_rate=0.0001 from configure_cell_parameters → XML default = 0.0001 ✓
# 2. Rule: oxygen DECREASES necrosis (high O2 = less necrosis)
add_single_cell_rule(
    cell_type="tumor",
    signal="oxygen",
    direction="decreases",     # high oxygen → LESS necrosis
    behavior="necrosis",
    min_signal=0.0,            # base_value: necrosis rate when signal is saturated (high O2)
    max_signal=38,             # informational, not written to CSV
    half_max=5.0,              # oxygen level at 50% effect
    hill_power=4               # moderately steep response
)
# Result: necrosis = 0 at high O2, rises toward 0.0001 (XML default) as O2 drops ✓
```

## 3. Common Mistakes Quick Reference

| # | Mistake | Symptom | Fix |
|---|---------|---------|-----|
| 1 | "From 0 towards 0" rule | Rule has no effect, cells ignore signal | Set nonzero XML default for the target behavior BEFORE adding rule |
| 2 | Dirichlet not enabled per-boundary | Substrate not maintained at boundaries | Set `dirichlet_enabled=True` in `add_single_substrate` |
| 3 | Wrong cycle model | Desired transition doesn't exist | Check `get_available_cycle_models()` |
| 4 | Cells placed outside domain | Cells immediately removed or ignored | Ensure placement radius/bounds fit within `create_simulation_domain` extents |
| 5 | Rule references nonexistent substrate | Rule silently fails | Add substrate BEFORE rules |
| 6 | Missing `export_cells_csv` | cells.csv not in project, no initial cells | Call `export_cells_csv()` before `create_physicell_project()` |
| 7 | No substrate interactions set | Cells don't consume/produce substrates | Call `set_substrate_interaction()` for each cell×substrate |
| 8 | `increases` vs `decreases` swapped | Behavior responds opposite to intent | "increases" = more signal → more behavior |
| 9 | Not checking simulation status | Don't know if simulation succeeded | Always call `get_simulation_status()` after `run_simulation()` |
| 10 | Forgetting `compile_physicell_project` | Simulation fails to run | Must compile before running |

## 4. Substrate Defaults

Use these typical values when adding substrates:

| Substrate | Diffusion (μm²/min) | Decay (1/min) | Initial | Dirichlet | Units |
|-----------|---------------------|---------------|---------|-----------|-------|
| oxygen | 100000 | 0.1 | 38.0 | 38.0 (enabled) | mmHg |
| glucose | 30000 | 0.0025 | 16.9 | 16.9 | mM |
| chemokine | 50000 | 0.01 | 0.0 | — | dimensionless |
| drug | 100000 | 0.01-0.1 | 0.0 | varies | μM |
| VEGF | 20000 | 0.01 | 0.0 | — | dimensionless |

For oxygen, **always enable Dirichlet boundaries** to maintain oxygenation:
```python
add_single_substrate(
    substrate_name="oxygen",
    diffusion_coefficient=100000,
    decay_rate=0.1,
    initial_condition=38.0,
    dirichlet_enabled=True,
    dirichlet_value=38.0,
    units="mmHg"
)
```

## 5. Cell Placement Patterns

| Pattern | Use when... | Key parameters |
|---------|------------|----------------|
| `random_disc` | Tumor mass, circular colony | center_x, center_y, radius, num_cells |
| `random_rectangle` | Tissue layer, rectangular region | x_min, x_max, y_min, y_max, num_cells |
| `single` | Individual cell placement | center_x, center_y |
| `grid` | Uniform tissue, monolayer | x_min, x_max, y_min, y_max, spacing |
| `annular` | Ring of cells (e.g., immune ring around tumor) | center_x, center_y, radius, inner_radius, num_cells |

Ensure all placements fit within the simulation domain. A 1000×1000 domain spans -500 to +500 in each axis.

## 6. Substrate Interactions

For every cell type × substrate pair, decide if cells consume, secrete, or ignore the substrate:

```python
# Tumor cells consume oxygen
set_substrate_interaction(cell_type="tumor", substrate="oxygen", uptake_rate=10.0)

# Tumor cells secrete chemokine
set_substrate_interaction(cell_type="tumor", substrate="chemokine", secretion_rate=0.1)
```

Common uptake rates:
- Oxygen uptake: 10.0 (typical tumor), 5.0 (normal cells)
- Glucose uptake: 0.5-2.0
- Drug uptake: 0.01-0.1

## 7. Literature Validation of Rules and Parameters

### When to use this workflow

Use this workflow whenever the user mentions literature, published data, or validation — e.g., "validate against literature", "determine from literature", "base on published values", "check my rules against papers". **This step is mandatory when the user requests it — do NOT skip it or wait to be prompted again.**

### Workflow: Build Model First, Then Validate

The correct order is:
1. **Build the full model** (Sections 1-6) — define substrates, cell types, rules, and parameters using your biological knowledge and scenario analysis
2. **Then validate ALL rules** against literature using the LiteratureValidation MCP
3. **Adjust parameters** if validation flags issues, then re-export

Do NOT try to extract parameters by reading papers directly — use PaperQA's RAG pipeline via the LiteratureValidation MCP.

### Step-by-step validation workflow

**Phase 1: Build a paper collection**
1. `mcp__LiteratureValidation__create_paper_collection("model_name")`
2. `mcp__LiteratureValidation__suggest_search_queries(cell_type, signal, direction, behavior)` — get optimized search queries
3. Search **bioRxiv first** (no rate limiting): `mcp__plugin_biorxiv_bioRxiv__search_preprints(category=..., recent_days=365)` — collect bioRxiv DOIs
4. Search PubMed: `mcp__plugin_pubmed_PubMed__search_articles(query)` — collect PMIDs
   - **If PubMed is unavailable or rate-limited:** Use `WebSearch` to find PMIDs (e.g. `"hypoxia tumor migration PMID"`, `"oxygen necrosis threshold mmHg PMID"`). Extract ONLY the PMIDs — do NOT extract parameters from web results.
5. `mcp__LiteratureValidation__add_papers_by_id(name, pmids=[...], biorxiv_dois=[...], fetch_pdfs=True)` — downloads PDFs and indexes them
6. Repeat steps 2-5 for each biological relationship in your model

**NEVER use `add_papers_to_collection()`** — only use `add_papers_by_id()` with real PMIDs or bioRxiv DOIs. Writing your own paper summaries and passing them as papers creates circular, fabricated validation.

**Phase 2: Validate ALL rules**
8. Use `mcp__PhysiCell__get_rules_for_validation()` — extract the rule list from your PhysiCell session
9. `mcp__LiteratureValidation__validate_rules_batch(name, rules)` — validate all rules at once, OR use `validate_rule()` individually for each rule. **Include signal_units when known** (e.g., signal_units="mmHg" for oxygen) to prevent unit confusion.
10. `mcp__LiteratureValidation__get_validation_summary(name)` — review support levels

**Phase 3: Act on results**
11. For rules flagged `unsupported` or `contradictory` — review the evidence summary and adjust half_max, hill_power, or direction as suggested
12. `mcp__PhysiCell__store_validation_results(validations)` — persist in PhysiCell session. **CRITICAL: Each validation dict MUST include `raw_paperqa_answer` containing the EXACT answer text from PaperQA's validate_rule() output. The support level will be independently verified from this text. Do NOT paraphrase, summarize, or omit the raw answer. Do NOT override PaperQA's findings with your own assessment.**
13. `mcp__PhysiCell__get_validation_report()` — final report
14. Re-export configuration if parameters were changed

### IMPORTANT: Never extract parameters manually

- **NEVER use `get_full_text_article`** — dumps 50KB+ into context, wastes the context window
- **NEVER use `get_article_metadata`** to read abstracts and manually extract values — let PaperQA do the extraction via `validate_rule()`
- **NEVER extract parameter values** (half_max, hill_power, rates) **from WebSearch/WebFetch results** — web snippets lack rigor. WebSearch is allowed ONLY for finding PMIDs and bioRxiv DOIs.
- **NEVER use `add_papers_to_collection()`** — writing your own paper text and passing it to PaperQA is fabrication. Use only `add_papers_by_id()` with real identifiers.

### Signal units

PaperQA can misinterpret parameter values if units are ambiguous. Common PhysiCell signal units:
- **oxygen** → mmHg (e.g., half_max=3.75 means 3.75 mmHg ≈ 0.49% O₂)
- **glucose** → mM
- **pressure** → dimensionless (0-1)
- **drugs** → μM

Auto-detection is built in for common signals, but always pass `signal_units` explicitly when available.

**Support levels:** strong, moderate, weak, contradictory, unsupported.
Rules flagged `unsupported` or `contradictory` should be reviewed. Validation may suggest parameter changes (half_max, hill_power).

## 8. Post-Simulation Checklist

After `run_simulation()`:
1. Poll `get_simulation_status()` **every 60 seconds** until complete or failed
2. Call `generate_simulation_gif()` to visualize
3. Call `get_simulation_output_files()` to list outputs
4. Verify cell counts are changing over time (not static)
5. If rules seem inactive, check `detailed_rules.txt` in output for "from X towards Y" values

## 9. Reference Files

For deep dives on specific topics:

- **`references/rules-and-hill-functions.md`** — Full Hill function math, worked examples, "from 0 towards 0" deep dive
- **`references/parameter-reference.md`** — Typical biological parameter values by cell type
- **`references/troubleshooting.md`** — Error diagnosis by symptom
- **`references/uq-calibration-workflow.md`** — Sensitivity analysis and calibration workflows
- **`references/physiboss-integration.md`** — Boolean network (MaBoSS/PhysiBoSS) integration
- **`references/literature-validation.md`** — Multi-server literature research and validation workflow (PDF indexing, PaperQA, bioRxiv)

## 10. Quick Start Template

For a basic tumor growth simulation:

```
1. create_session()
2. analyze_biological_scenario("Tumor growth with oxygen-dependent proliferation and necrosis")
3. create_simulation_domain(domain_x=1000, domain_y=1000, domain_z=20, max_time=4320)
4. add_single_substrate("oxygen", 100000, 0.1, 38.0, dirichlet_enabled=True, dirichlet_value=38.0, units="mmHg")
5. add_single_cell_type("tumor")
6. configure_cell_parameters(cell_type="tumor", volume_total=2500, motility_speed=0.5, apoptosis_rate=5.31667e-5, necrosis_rate=0.00277)
7. set_substrate_interaction(cell_type="tumor", substrate="oxygen", uptake_rate=10.0)
8. add_single_cell_rule(cell_type="tumor", signal="oxygen", direction="decreases", behavior="necrosis", min_signal=0, half_max=3.75, hill_power=8)
9. add_single_cell_rule(cell_type="tumor", signal="pressure", direction="decreases", behavior="cycle entry", min_signal=0, half_max=1.0, hill_power=4)
10. place_initial_cells(cell_type="tumor", pattern="random_disc", num_cells=200, radius=100)
11. export_xml_configuration()
12. export_cell_rules_csv()
13. export_cells_csv()
14. create_physicell_project("tumor_growth")
15. compile_physicell_project("tumor_growth")
16. run_simulation("tumor_growth")
17. get_simulation_status(simulation_id)   # poll until complete
18. generate_simulation_gif(simulation_id)
```
